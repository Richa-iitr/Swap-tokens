const DSA = require("dsa-connect");
const hre = require("hardhat");
const dotenv = require("dotenv");
const { network } = require("hardhat");
dotenv.config({ path: __dirname + "/.env" });

const {PRIVATE_KEY} = process.env.PRIVATE_KEY;
const address = "0x15C6b352c1F767Fa2d79625a40Ca4087Fab9a198";

async function main() {
  const dsa = new DSA({
    web3: web3,
    mode: "node",
    privateKey: PRIVATE_KEY,
  });

  await network.provider.send("hardhat_setBalance", [
    address,
    "0x2C15833042008639680",
  ]);

  await dsa.build({
    gasPrice: web3.utils.toWei("1000000", "gwei"),
    authority: address,
    version: 2,
  });

  let accounts = await dsa.getAccounts(address);
  console.log(accounts);

  let dsaID = accounts[0].id;

  await network.provider.send("hardhat_setBalance", [
    accounts[0].address,
    "0x2C15833042008639680",
  ]);

  //configuring the global dsa instance
  await dsa.setInstance(dsaID);
  let spells = dsa.Spell();

  //spell to deposit ETH to compound
  await spells.add({
    connector: "compound",
    method: "deposit",
    args: ["ETH-A", "10000000000000", 0, 0],
  });

  await spells.add({
    connector: "compound",
    method: "borrow",
    args: ["USDC-A", "10000", 0, 0],
  });

  console.log("Instance:", dsa.instance);
  console.log(await web3.eth.getBalance(accounts[0].address));

  const buyAdr = "0x6b175474e89094c44da98b954eedeac495271d0f"; //DAI
  const USDC = "0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48";
  const ETH = "0xEeeeeEeeeEeEeeEeEeEeeEEEeeeeEeeeeeeeEEeE";
  const calldataUSDCDAI =
    "0x7c025200000000000000000000000000220bda5c8994804ac96ebe4df184d25e5c2196d400000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000180000000000000000000000000a0b86991c6218b36c1d19d4a2e9eb0ce3606eb480000000000000000000000006b175474e89094c44da98b954eedeac495271d0f000000000000000000000000220bda5c8994804ac96ebe4df184d25e5c2196d4000000000000000000000000de9e14c2d16fd4060c6e83ecf9e5337ed598908e00000000000000000000000000000000000000000000000000000000000003e8000000000000000000000000000000000000000000000000000388bb3af6f1ba00000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003a000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000001400000000000000000000000000000000000000000000000000000000000000220000000000000000000000000a0b86991c6218b36c1d19d4a2e9eb0ce3606eb48000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000044a9059cbb000000000000000000000000b1dc62ec38e6e3857a887210c38418e4a17da5b2000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000a0b86991c6218b36c1d19d4a2e9eb0ce3606eb48000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000044a9059cbb000000000000000000000000b5214edee5741324a13539bcc207bc549e2491ff00000000000000000000000000000000000000000000000000000000000003e60000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000a4b757fed6000000000000000000000000b5214edee5741324a13539bcc207bc549e2491ff000000000000000000000000a0b86991c6218b36c1d19d4a2e9eb0ce3606eb480000000000000000000000006b175474e89094c44da98b954eedeac495271d0f0000000000000000002dc6c01111111254fb6c44bac0bed2854e76f90643097d000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a78de0a2";
  
  //spell to swap USDC with DAI
  spells.add({
    connector: "1INCH-A",
    method: "sell",
    args: [buyAdr, USDC, "1000", "994762659656122903", calldataUSDCDAI, 0],
  });

  const calldataETHDAI =
    "0x7c025200000000000000000000000000220bda5c8994804ac96ebe4df184d25e5c2196d400000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000180000000000000000000000000eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee0000000000000000000000006b175474e89094c44da98b954eedeac495271d0f000000000000000000000000220bda5c8994804ac96ebe4df184d25e5c2196d4000000000000000000000000de9e14c2d16fd4060c6e83ecf9e5337ed598908e00000000000000000000000000000000000000000000000000000000000003e800000000000000000000000000000000000000000000000000000000002ee86500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004800000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000180000000000000000000000000000000000000000000000000000000000000022000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000064d1660f99000000000000000000000000eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee000000000000000000000000b1dc62ec38e6e3857a887210c38418e4a17da5b2000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc200000000000000000000000000000000000000000000000000000000000003e600000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000004d0e30db000000000000000000000000000000000000000000000000000000000000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000044a9059cbb000000000000000000000000efcf8e86a2c6ab9be7fe00241651cb1b0a4983fb00000000000000000000000000000000000000000000000000000000000003e60000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000a4b757fed6000000000000000000000000efcf8e86a2c6ab9be7fe00241651cb1b0a4983fb000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc20000000000000000000000006b175474e89094c44da98b954eedeac495271d0f0000000000000000002dc6c01111111254fb6c44bac0bed2854e76f90643097d000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a78de0a2";
  
  //spell to swap to ETH with DAI
  spells.add({
    connector: "1INCH-A",
    method: "sell",
    args: [
      buyAdr,
      ETH,
      "1000",
      "3074149773000000307723",
      calldataETHDAI,
      0,
    ],
  });

  console.log("Spells:", dsa.encodeSpells(spells));

  //casting the spells
  console.log(
    "Transcation Hash:",
    await dsa.cast({
      spells,
      gasPrice: web3.utils.toWei("1000000", "gwei"),
      value: "1000000",
    })
  );
}

main()
  .then(() => process.exit(0))
  .catch((error) => {
    console.error(error);
    process.exit(1);
  });
